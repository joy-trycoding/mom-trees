<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>媽媽樹洞 - 傾聽你的心事</title>
    <!-- 魔法：使用 Tailwind CSS 讓網頁變得很漂亮 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 魔法：使用 Inter 字體讓文字看起來很舒服 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 1s ease-in-out; }
        /* 隱藏原生捲軸，但保留捲動功能 */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }
        .overflow-y-auto {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

<div id="app" class="flex flex-col items-center justify-center min-h-screen font-sans"></div>

<script type="module">
    // 獨立運作版：這個版本不依賴 Firebase，所有資料都儲存在瀏覽器中。
    // 因此，請注意：如果重新整理頁面，對話紀錄將會消失。
    
    // 準備好所有的網頁頁面
    const pages = {
        intro: () => `
            <div class="min-h-screen bg-gradient-to-br from-purple-100 to-pink-100 dark:from-purple-900 dark:to-pink-900 text-gray-900 dark:text-gray-100 font-sans animate-fadeIn">
                <div class="max-w-xl mx-auto p-4 md:p-8">
                    <div class="p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl text-center">
                        <h1 class="text-4xl font-bold mb-4 text-purple-600 dark:text-purple-400">歡迎來到媽媽樹洞</h1>
                        <p class="text-lg mb-6 leading-relaxed">
                            想罵老公、罵心機同事、難搞公婆、育兒抱怨...通通來你的秘密樹洞，隨時聊聊！
                        </p>
                        <div class="mb-6 text-gray-700 dark:text-gray-300">
                            <h2 class="text-xl font-bold mb-2">來自媽媽們的見證</h2>
                            <div class="space-y-4 text-left">
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner italic flex items-center space-x-4">
                                    <svg class="w-16 h-16 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p>「在這裡，我終於可以喘口氣了。感覺有個隱形的肩膀可以依靠。」 - 匿名媽媽一號</p>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner italic flex items-center space-x-4">
                                    <svg class="w-16 h-16 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p>「對話中的陪伴讓我不覺得自己是孤單的，這對我幫助很大。」 - 匿名媽媽二號</p>
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-inner italic flex items-center space-x-4">
                                    <svg class="w-16 h-16 text-gray-400 dark:text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p>「很感謝能有這樣的地方，讓我可以說出那些平時不好意思說的話。」 - 匿名媽媽三號</p>
                                </div>
                            </div>
                        </div>
                        <div class="mb-20 text-gray-700 dark:text-gray-300">
                            <h2 class="text-xl font-bold mb-2">關於開發者</h2>
                            <p class="text-sm">
                                嗨，我是這款應用的開發者。作為一個孩子們的父母，我深知育兒路上的辛勞與孤獨。我希望能創造一個專屬於媽媽們的樹洞，讓您們在這裡能卸下心防，獲得片刻的寧靜與支持。
                            </p>
                        </div>
                    </div>
                </div>
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-white dark:bg-gray-800 shadow-lg text-center">
                    <button id="start-btn" class="w-full px-8 py-4 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-300">
                        開啟樹洞
                    </button>
                </div>
            </div>
            `,
        login: () => `
            <div class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg text-center font-sans">
                <div class="max-w-xl p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                    <h1 class="text-3xl font-bold mb-2 text-purple-600 dark:text-purple-400">進入樹洞前的準備</h1>
                    <p class="text-sm mb-6 text-gray-600 dark:text-gray-400">
                        這個樹洞是為您獨立建立的，**30分鐘後會自動消失**，請安心地說出您想說的話。
                    </p>
                    <div class="mb-6">
                        <input id="nickname-input" type="text" placeholder="請輸入您的暱稱..." class="w-full p-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" />
                    </div>
                    <div class="mb-8">
                        <h2 class="text-lg font-bold mb-4 text-left">請選擇一個陪伴您的角色：</h2>
                        <div id="tone-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 按鈕會在這裡被 JavaScript 生成 -->
                        </div>
                    </div>
                    <button id="start-chat-btn" class="w-full px-8 py-4 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-300">
                        開啟您的專屬樹洞
                    </button>
                    <div id="alert-box" class="mt-4 hidden p-4 bg-red-500 text-white rounded-lg shadow-md"></div>
                </div>
            </div>
            `,
        chat: () => `
            <div class="flex flex-col h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg font-sans">
                <div class="p-4 bg-white dark:bg-gray-800 rounded-b-lg shadow-md flex justify-between items-center sticky top-0 z-10">
                    <h1 class="text-2xl font-bold">媽媽樹洞</h1>
                    <div class="flex items-center space-x-4">
                        <button id="change-chat-btn" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-full shadow-lg hover:bg-red-600 transition-colors duration-300 text-sm">
                            換個人聊
                        </button>
                        <div class="text-right">
                            <p class="text-sm">對話剩餘時間: <span id="timer-display" class="font-mono text-red-500"></span></p>
                            <p class="text-xs">正在與<span id="tone-display" class="font-bold text-blue-500"></span>對話</p>
                        </div>
                    </div>
                </div>
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-4 pb-24">
                    <div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                        歡迎，<span id="nickname-display"></span>！這裡是一個專屬於您的空間。<br/>無論您有什麼心事，都可以在這裡告訴我。我會以最適合您的語氣，靜靜聆聽。
                    </div>
                </div>
                <div class="fixed bottom-0 left-0 right-0 p-2 bg-white dark:bg-gray-800 rounded-t-lg shadow-md">
                    <div class="flex max-w-2xl mx-auto">
                        <input id="message-input" type="text" placeholder="輸入您的訊息..." class="flex-1 p-3 mr-2 rounded-xl border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors duration-200" />
                        <button id="send-btn" class="px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-colors duration-200">
                            發送
                        </button>
                    </div>
                </div>
            </div>
            `,
        end: () => `
            <div class="flex flex-col items-center justify-center h-screen p-4 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 rounded-lg text-center font-sans">
                <div class="max-w-xl p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                    <h1 class="text-4xl font-bold mb-4 text-purple-600 dark:text-purple-400">對話結束了</h1>
                    <p class="text-lg mb-6 leading-relaxed">
                        感謝您的分享，希望您感覺好一些。<br/>如果還有需要，這個樹洞隨時為您敞開。
                    </p>
                    <button onclick="window.location.reload()" class="w-full px-8 py-4 bg-purple-600 text-white font-semibold rounded-full shadow-lg hover:bg-purple-700 transition-colors duration-300">
                        重新開始對話
                    </button>
                </div>
            </div>
        `
    };

    const characterPrompts = {
      humorous: `您現在扮演一位風趣且樂觀的朋友。請站在陪伴者的角度上，用幽默、輕鬆、有趣的語氣回應，可以適度地開一些小玩笑，幫助使用者排解壓力與焦慮。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
      eight_pm_drama: `您現在扮演一位八點檔毒舌。請站在陪伴者的角度上，用一針見血、帶點戲劇性的辛辣語氣，與使用者一起吐槽與抱怨使用者提到的對象或處境，直接點出問題核心，但請保持尊重。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
      intellectual: `您現在扮演一位知性且充滿洞見的諮詢師。請站在陪伴者的角度上，用理性的口吻、清晰的邏輯，並提供客觀的見解來回應，以幫助使用者分析和解決問題。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
      warm: `您現在扮演一位溫暖且充滿同理心的朋友。請站在陪伴者的角度上，用溫柔、鼓勵且支持的語氣回應，展現出對使用者的理解與關懷，讓使用者感到被擁抱。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
      calm_dude: `您現在扮演一位淡定哥。請站在陪伴者的角度上，用極度冷靜、沉著、波瀾不驚的語氣回應，盡量減少情緒詞彙，只提供最客觀的觀察。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
      apology_humor: `您現在扮演一位幽默道歉派。請站在陪伴者的角度上，無論發生什麼事，都用誇張、有趣的方式對事情道歉，讓對話充滿自嘲的幽默感。請將回應的長度控制在100個中文字以內，並確保語氣自然不說教。`,
    };
    
    // 儲存對話紀錄的陣列
    let chatHistory = [];
    let timerInterval = null;

    // 渲染頁面內容
    function renderPage(pageName) {
        document.getElementById('app').innerHTML = pages[pageName]();
        if (pageName === 'intro') {
            document.getElementById('start-btn').addEventListener('click', () => renderPage('login'));
        } else if (pageName === 'login') {
            setupLoginPage();
        } else if (pageName === 'chat') {
            setupChatPage();
        }
    }

    // 檢查 localStorage 是否有儲存的暱稱，如果沒有則顯示 intro 頁面
    // 這讓使用者可以直接從 chat 頁面重新整理，不會回到 intro 頁面
    const savedNickname = localStorage.getItem('nickname');
    if (savedNickname) {
      renderPage('chat');
    } else {
      renderPage('intro');
    }

    // 登入頁面的功能
    function setupLoginPage() {
        const nicknameInput = document.getElementById('nickname-input');
        const toneButtonsContainer = document.getElementById('tone-buttons');
        const startChatBtn = document.getElementById('start-chat-btn');
        const alertBox = document.getElementById('alert-box');

        const tones = [
            { key: 'humorous', label: '幽默夥伴', description: '用輕鬆有趣的語氣，為您的煩惱找到釋放出口。' },
            { key: 'eight_pm_drama', label: '八點檔毒舌', description: '一針見血的犀利評論，幫您吐槽所有不愉快！' },
            { key: 'intellectual', label: '知性姊姊', description: '提供深刻見解與理性分析，讓您看見問題的另一面。' },
            { key: 'warm', label: '溫暖好友', description: '給予溫柔的陪伴與鼓勵，讓您感到被理解與支持。' },
            { key: 'calm_dude', label: '淡定哥', description: '以平靜且沉著的語氣回應，讓您從混亂中找到寧靜。' },
            { key: 'apology_humor', label: '幽默道歉派', description: '用自嘲與誇張的道歉，為您的情緒找到幽默的出口。' },
        ];

        let selectedTone = '';

        tones.forEach(tone => {
            const button = document.createElement('button');
            button.className = `flex flex-col items-center p-4 rounded-xl border-2 transition-all duration-300 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700`;
            button.innerHTML = `<span class="font-bold text-lg mb-1">${tone.label}</span><span class="text-xs text-center">${tone.description}</span>`;
            button.addEventListener('click', () => {
                selectedTone = tone.key;
                document.querySelectorAll('#tone-buttons button').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-600', 'shadow-lg');
                    btn.classList.add('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-gray-100', 'border-gray-300', 'dark:border-gray-600');
                });
                button.classList.add('bg-blue-500', 'text-white', 'border-blue-600', 'shadow-lg');
                button.classList.remove('bg-white', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-gray-100', 'border-gray-300', 'dark:border-gray-600');
            });
            toneButtonsContainer.appendChild(button);
        });

        startChatBtn.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            if (!nickname || !selectedTone) {
                alertBox.textContent = '請輸入暱稱並選擇一個角色！';
                alertBox.classList.remove('hidden');
            } else {
                localStorage.setItem('nickname', nickname);
                localStorage.setItem('selectedTone', selectedTone);
                renderPage('chat');
            }
        });
    }

    // 聊天頁面的功能
    function setupChatPage() {
        const nickname = localStorage.getItem('nickname');
        const selectedTone = localStorage.getItem('selectedTone');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const timerDisplay = document.getElementById('timer-display');
        const toneDisplay = document.getElementById('tone-display');
        const changeChatBtn = document.getElementById('change-chat-btn');
        const nicknameDisplay = document.getElementById('nickname-display');
        
        // 載入 localStorage 中儲存的對話紀錄
        const savedChatHistory = localStorage.getItem('chatHistory');
        if (savedChatHistory) {
            chatHistory = JSON.parse(savedChatHistory);
        } else {
            chatHistory = [];
        }

        nicknameDisplay.textContent = nickname;
        const tones = [
            { key: 'humorous', label: '幽默夥伴' },
            { key: 'eight_pm_drama', label: '八點檔毒舌' },
            { key: 'intellectual', label: '知性姊姊' },
            { key: 'warm', label: '溫暖好友' },
            { key: 'calm_dude', label: '淡定哥' },
            { key: 'apology_humor', label: '幽默道歉派' },
        ];
        toneDisplay.textContent = tones.find(t => t.key === selectedTone).label;

        let timer = 1800;
        clearInterval(timerInterval); // 清除舊的計時器
        timerInterval = setInterval(() => {
            timer--;
            const minutes = Math.floor(timer / 60);
            const seconds = timer % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timer <= 0) {
                clearInterval(timerInterval);
                renderPage('end');
            }
        }, 1000);

        // 顯示對話紀錄
        const renderMessages = () => {
            messagesContainer.innerHTML = '';
            messagesContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                歡迎，${nickname}！這裡是一個專屬於您的空間。<br/>無論您有什麼心事，都可以在這裡告訴我。我會以最適合您的語氣，靜靜聆聽。
            </div>`;
            chatHistory.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`;
                msgDiv.innerHTML = `<div class="p-3 rounded-xl max-w-xs md:max-w-md lg:max-w-lg shadow-md ${msg.type === 'user' ? 'bg-blue-500 text-white' : 'bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100'}">
                    <p class="text-sm leading-snug">${msg.text}</p>
                </div>`;
                messagesContainer.appendChild(msgDiv);
            });
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const sendMessage = async () => {
            const text = messageInput.value.trim();
            if (text === '') return;

            // 新增使用者訊息到本地紀錄並重新渲染
            const userMsg = { text, type: 'user' };
            chatHistory.push(userMsg);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderMessages();
            messageInput.value = '';

            // 顯示 AI 正在輸入
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = `<div class="p-3 rounded-xl max-w-xs md:max-w-md lg:max-w-lg bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400 shadow-md animate-pulse">
                <p class="text-sm leading-snug">正在輸入中...</p>
            </div>`;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // 獲取 AI 回應並新增到本地紀錄
            const aiResponse = await getAiResponse(text, selectedTone);
            const aiMsg = { text: aiResponse, type: 'ai' };
            chatHistory.push(aiMsg);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            
            typingDiv.remove(); // 移除打字提示
            renderMessages();
        };

        const getAiResponse = async (userMessage, tone) => {
            const chatHistoryForAPI = [{ role: "user", parts: [{ text: `${characterPrompts[tone]}使用者說：${userMessage}` }] }];
            const payload = { contents: chatHistoryForAPI };
            
            // 修正：移除 API 金鑰參數，因為環境會自動提供，URL 必須保持純淨
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`;

            const maxRetries = 5;
            let attempt = 0;
            while (attempt < maxRetries) {
              try {
                const response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API 錯誤回應:", response.status, errorText);
                    return "目前無法回應，請稍後再試。";
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                  return result.candidates[0].content.parts[0].text;
                } else {
                  console.error("API 回應結構不正確或內容缺失", result);
                  return "目前無法回應，請稍後再試。";
                }
              } catch (error) {
                console.error("呼叫 API 時發生錯誤:", error);
                attempt++;
                const delay = Math.pow(2, attempt) * 1000;
                if (attempt < maxRetries) {
                  await new Promise(res => setTimeout(res, delay));
                } else {
                  return "發生網路錯誤，請檢查您的連線。";
                }
              }
            }
        };

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        changeChatBtn.addEventListener('click', async () => {
            // 使用客製化的確認視窗，取代瀏覽器原生的 alert
            const customConfirm = (message) => {
                return new Promise((resolve) => {
                    const confirmBox = document.createElement('div');
                    confirmBox.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50';
                    confirmBox.innerHTML = `
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center max-w-sm w-full">
                            <p class="text-lg font-semibold mb-4">${message}</p>
                            <div class="flex justify-around space-x-4">
                                <button id="confirm-yes" class="px-6 py-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-colors duration-200">確定</button>
                                <button id="confirm-no" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-full hover:bg-gray-400 transition-colors duration-200">取消</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmBox);
                    document.getElementById('confirm-yes').onclick = () => {
                        confirmBox.remove();
                        resolve(true);
                    };
                    document.getElementById('confirm-no').onclick = () => {
                        confirmBox.remove();
                        resolve(false);
                    };
                });
            };

            const userConfirmed = await customConfirm('嗨，離開之後就無法進入現在的對話喔!!');
            if (userConfirmed) {
                clearInterval(timerInterval);
                localStorage.removeItem('nickname');
                localStorage.removeItem('selectedTone');
                localStorage.removeItem('chatHistory');
                window.location.reload();
            }
        });

        // 初始渲染對話紀錄
        renderMessages();
    }
</script>
</body>
</html>
